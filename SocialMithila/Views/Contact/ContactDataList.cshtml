@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* Your same styling */
    fieldset {
        background-color: #eeeeee;
    }

    legend {
        background-color: gray;
        color: white;
        padding: 5px 10px;
    }

    .custom-gridjs-th {
        background-color: #794abf !important;
        color: #fff !important;
    }

    .fieldsethead {
        border: 1px groove #b5025c !important;
        margin: 0;
        padding: 10px;
        border-radius: 4px;
        background-color: #f5f5f5;
    }

    .legendhead {
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        background: #b5025c;
        border-radius: 4px;
        padding: 5px 10px;
    }

    #tblUserData th {
        background: #5e2f82 !important;
        color: white !important;
    }

    td, th {
        white-space: nowrap !important;
    }
</style>

<div class="main-content app-content">
    <div class="container-fluid">
        <div class="row row-sm ">
            <div class="col-md-12 col-xl-12">
                <div id="dvloader" class="se-pre-con" style="display:none"></div>

                <div class="card overflow-hidden review-project">
                    <div class="card-body">

                        <!-- Filter Section -->
                        <fieldset class="fieldsethead">
                            <legend class="legendhead">Filter</legend>
                            <br />
                            <div class="row">
                                <!-- ✅ Select User -->
                                <div class="col-xl-3">
                                    <div class="">
                                        <div class="">
                                            <label class="fw-semibold mb-2">Select User:</label>
                                            <select multiple class="form-select select2" id="ddlUserIds" style="width:100%">
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- ❌ From Date, To Date, Status removed -->
                                <!-- ✅ Search & Reset Buttons -->
                                <div class="col-xl-4" style="margin-top:10px">
                                    <div class="">
                                        <div class="">
                                            <div class="input-group">
                                                <button class="btn btn-primary btn-block" id="btnSearch" title="Search" style="border-radius:7px" type="button">Search</button>
                                                &nbsp;&nbsp;
                                                <button class="btn btn-danger btn-block" title="Export To Excel" style="border-radius:7px" type="button">
                                                    Reset
                                                    <i class="fa fa-reset" style="font-size:17px" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-2" style="margin-top:30px">
                                    <div class="">
                                        <div class="">
                                            <div class="input-group">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>


                        <!-- Contact Table -->
                        <div class="row mt-4">
                            <div class="col-xl-12">
                                <div class="card custom-card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Contact List</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table text-nowrap table-bordered mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Sr No</th>
                                                        <th>User Name</th>
                                                        <th>Email ID</th>
                                                        <th>Phone No</th>
                                                        <th>Message</th>
                                                        <th>Contact By</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tblUserData"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div id="paginationContainer" class="d-flex justify-content-end align-items-center mt-3 mb-3"></div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    var count = 0;

    $(document).ready(function () {
        BindUsers();
        loadContacts(1);

        $('#btnSearch').click(function () {
            loadContacts(1);
        });

        $('#btnReset').click(function () {
            $('#ddlUserIds').val(null).trigger('change');
            $('#txtFromDate').val('');
            $('#txtToDate').val('');
            $('#ddlStatus').val('');
            loadContacts(1);
        });
    });

    function formatUser(user) {
        if (!user.id) return user.text;
        const img = $(user.element).data('image');
        return $(`<span><img src="${img}" class="img-circle" style="width:25px; height:25px; margin-right:8px;"> ${user.text}</span>`);
    }

    function formatUserSelection(user) {
        return user.text;
    }

    function BindUsers() {
        $.ajax({
            url: '/Home/GetUsersForDropdown',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                $('#ddlUserIds').empty();
                $.each(data, function (i, item) {
                    $('#ddlUserIds').append(`<option value="${item.Id}" data-image="${item.ProfilePhoto}">${item.Text}</option>`);
                });
                $('#ddlUserIds').select2({
                    templateResult: formatUser,
                    templateSelection: formatUserSelection
                });
            }
        });
    }

    function loadContacts(pageIndex) {
        var userIds = $('#ddlUserIds').val() ? $('#ddlUserIds').val().join(',') : null;
        var fromDate = $('#txtFromDate').val();
        var toDate = $('#txtToDate').val();
        var status = $('#ddlStatus').val();

        $.ajax({
            url: '/Contact/GetContactList',
            type: 'GET',
            dataType: 'json',
            data: { userIds, fromDate, toDate, status, pageIndex, pageSize: 10 },
            success: function (response) {
                var rows = '';
                count = (pageIndex - 1) * 10;
                $.each(response.Data, function (i, c) {
                    count++;
                    rows += `<tr>
                        <td>${count}</td>
                        <td>${c.UserName ?? ''}</td>
                        <td>${c.ContactEmail ?? ''}</td>
                        <td>${c.ContactMobileNumber ?? ''}</td>
                        <td>${c.ContactMessage ?? ''}</td>
                        <td>${c.ContactBy ?? ''}</td>
                        <td>
                            <a href="#" class="btn btn-sm btn-info"><i class="ri-edit-line"></i></a>
                             <a href="javascript:void(0);"
   class="btn btn-sm btn-danger btn-delete"
   data-id="${c.ContactId}">
   <i class="ri-delete-bin-line"></i>
</a>

                        </td>
                    </tr>`;
                });
                $('#tblUserData').html(rows);
                let totalPages = Math.ceil(response.TotalCount / 10);
                $('#paginationContainer').html(getPaginationHtml(pageIndex, totalPages));
            },
            error: function () {
                $('#tblUserData').html('<tr><td colspan="7" class="text-center text-danger">Error fetching data.</td></tr>');
            }
        });
    }

    function getPaginationHtml(currentPage, totalPages) {
        let html = '<ul class="pagination pagination-sm mb-0">';
        html += currentPage === 1 ? `<li class="page-item disabled"><a class="page-link">Previous</a></li>` :
            `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(${currentPage - 1})">Previous</a></li>`;

        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="loadContacts(${i})">${i}</a></li>`;
        }

        html += currentPage === totalPages ? `<li class="page-item disabled"><a class="page-link">Next</a></li>` :
            `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(${currentPage + 1})">Next</a></li>`;
        html += '</ul>';
        return html;
    }

    $(document).on('click', '.btn-delete', function () {
        var contactId = $(this).data('id');

        Swal.fire({
            title: "Are you sure?",
            text: "Do you really want to delete this contact?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Contact/DeleteContact',
                    type: 'POST',
                    data: { id: contactId },
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                title: "Deleted!",
                                text: response.message,
                                icon: "success",
                                timer: 1500,
                                showConfirmButton: false
                            });

                           
                            $('#row_' + contactId).fadeOut(400, function () { $(this).remove(); });

                        } else {
                            Swal.fire("Error!", response.message, "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Error!", "Something went wrong.", "error");
                    }
                });
            }
        });
    });








</script>


@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* General Card & Scroll */
    .card {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .m-scroll {
        max-height: 350px;
        overflow-y: auto;
    }

    .list-group-item {
        border-radius: 8px;
        margin-bottom: 6px;
        transition: all 0.2s ease;
    }

        .list-group-item:hover {
            background-color: #f7f7f7;
            transform: translateY(-2px);
        }

    /* Badge & Text Gradients */
    .text-primary {
        color: #2575fc;
    }

    .text-success {
        color: #00b09b;
    }

    .text-danger {
        color: #f85032;
    }

    .text-pink {
        color: #ff4b2b;
    }

    .text-purple {
        color: #6a11cb;
    }

    /* Activity Feed */
    .activity {
        max-height: 400px;
        overflow-y: auto;
    }

    .img-activity {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
    }

    .item-activity p {
        margin: 0;
        font-size: 13px;
    }

    .added-project {
        font-weight: 600;
    }

    /* Task Statistics */
    .task-box {
        border-radius: 12px;
        padding: 20px;
        color: #fff;
    }

        .task-box.primary {
            background: linear-gradient(90deg,#6a11cb,#2575fc);
        }

        .task-box.danger {
            background: linear-gradient(90deg,#f85032,#e73827);
        }

    .tasks {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .post {
        position: relative;
    }

    .actions button {
        cursor: pointer;
    }

    .emoji-reactions {
        display: none !important;
        top: -55px;
        left: -85px;
        z-index: 1000;
        flex-direction: row;
    }

    .like-container:hover .emoji-reactions {
        display: flex !important;
    }

    .emoji-reactions span {
        cursor: pointer;
        font-size: 24px;
        margin: 0 5px;
        transition: transform 0.2s;
    }

        .emoji-reactions span:hover {
            transform: scale(1.5);
        }

    /* comment section */
    .comment {
        background: #f0f2f5;
        padding: 6px 10px;
        border-radius: 12px;
        font-size: 14px;
        margin-bottom: 4px;
    }
</style>

<!-- Page Header Close -->
<!-- Start::app-content -->
<div class="main-content app-content">
    <div class="container-fluid">
        <!-- row -->
        <div class="row row-sm">
            <!-- Local Events -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card overflow-hidden project-card">
                    <div class="card-body">
                        <a href="~/Business/BusinessMgmt" target="_blank">
                            <div class="d-flex">
                                <div class="my-auto">
                                    <!-- Business Icon -->
                                    <svg class="me-4 ht-60 wd-60 my-auto primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                                        <path d="M8 22l4-12h40l4 12v30a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4V22z" fill="#e0e0e0" />
                                        <path d="M52 10H12l-4 12h48l-4-12z" fill="#b5025c" />
                                        <rect x="14" y="32" width="12" height="14" rx="2" fill="#fff" />
                                        <rect x="30" y="32" width="20" height="6" rx="2" fill="#fff" />
                                    </svg>
                                </div>

                                <div class="project-content">
                                    <h6>Total Businesses</h6>
                                    <ul>
                                        <li><strong>Total: </strong> <span id="txtTotalBusiness"></span></li>
                                    </ul>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>


            <!-- Community Tasks -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card overflow-hidden project-card">
                    <div class="card-body">
                        <a href="~/Business/CategoryMgmt" target="_blank">
                            <div class="d-flex">
                                <div class="my-auto">

                                    <!-- Category Icon -->
                                    <svg class="me-4 ht-60 wd-60 my-auto warning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                                        <path d="M6 18h52v32a4 4 0 0 1-4 4H10a4 4 0 0 1-4-4V18z" fill="#f7d154" />
                                        <path d="M6 14a4 4 0 0 1 4-4h14l4 4h30a4 4 0 0 1 4 4v4H6v-8z" fill="#f4b400" />
                                        <rect x="14" y="30" width="36" height="6" rx="2" fill="#fff" />
                                        <rect x="14" y="40" width="28" height="6" rx="2" fill="#fff" />
                                    </svg>

                                </div>

                                <div class="project-content">
                                    <h6>Total Categories</h6>
                                    <ul>
                                        <li>
                                            <strong>Registered</strong>
                                            <span id="txtTotalCategory"></span>
                                        </li>
                                    </ul>
                                </div>

                            </div>
                        </a>
                    </div>
                </div>
            </div>


            <!-- Donations/Contributions -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card overflow-hidden project-card">
                    <div class="card-body">
                        <a href="~/Business/SubCategoryMgmt" target="_blank">
                            <div class="d-flex">
                                <div class="my-auto">

                                    <!-- Sub-Category Icon -->
                                    <svg class="me-4 ht-60 wd-60 my-auto info" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                                        <rect x="6" y="8" width="20" height="20" rx="3" fill="#00bcd4" />
                                        <rect x="6" y="36" width="20" height="20" rx="3" fill="#0097a7" />

                                        <rect x="28" y="8" width="30" height="8" rx="3" fill="#80deea" />
                                        <rect x="28" y="20" width="30" height="8" rx="3" fill="#4dd0e1" />

                                        <rect x="28" y="36" width="30" height="8" rx="3" fill="#4dd0e1" />
                                        <rect x="28" y="48" width="30" height="8" rx="3" fill="#26c6da" />
                                    </svg>

                                </div>

                                <div class="project-content">
                                    <h6>Sub Categories</h6>
                                    <ul>
                                        <li>
                                            <strong>Total</strong>
                                            <span id="txtTotalSubCategory"></span>
                                        </li>
                                    </ul>
                                </div>

                            </div>
                        </a>
                    </div>
                </div>
            </div>


            <!-- Active Members / Facebook Feed -->
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 mb-4">
                <div class="card overflow-hidden project-card">
                    <div class="card-body">
                        <a href="~/Home/Contact" target="_blank">
                            <div class="d-flex">
                                <div class="my-auto">

                                    <!-- User Icon -->
                                    <svg class="me-4 ht-60 wd-60 my-auto primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                                        <circle cx="32" cy="20" r="14" fill="#5c6bc0" />
                                        <path d="M8 56c0-12 10-22 24-22s24 10 24 22v4H8v-4z" fill="#7986cb" />
                                    </svg>

                                </div>

                                <div class="project-content">
                                    <h6>Total Users</h6>
                                    <ul>
                                        <li>
                                            <strong>Registered</strong>
                                            <span id="txtTotalUsers"></span>
                                        </li>
                                    </ul>
                                </div>

                            </div>
                        </a>
                    </div>
                </div>
            </div>


        </div>

        <!-- row -->
        <!-- row -->
        <div class="row row-sm ">
            <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">
                <div class="card overflow-hidden">
                    <div class="card-header bg-transparent p-4">
                        <div class="d-flex justify-content-between">
                            <h4 class="card-title mg-b-10">Community Growth</h4>
                        </div>
                        <p class="fs-12 text-muted mb-2">
                            Track how the Mithila community is growing across users, businesses, and Posts.
                            <a class="text-primary" href="" style="display:none">Learn more</a>
                        </p>
                    </div>
                    <div class="card-body pd-y-7">
                        <div class="area chart-legend mb-0 d-flex justify-content-center">
                            <div class="ms-2">
                                <i class="mdi mdi-account-multiple text-primary"></i> Users
                            </div>
                            <div class="ms-2">
                                <i class="mdi mdi-store text-pink"></i> Businesses
                            </div>
                            <div class="ms-2">
                                <i class="mdi mdi-calendar text-success"></i> Posts
                            </div>
                        </div>
                        <!-- keep existing chart container, just change the context -->
                        <div id="communitygrowth1"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 col-md-12 col-lg-12 col-xl-4">
                <div class="card overflow-hidden">
                    <div class="card-body pb-3">
                        <div class="card-header">
                            <h4 class="card-title mg-b-10">Posts &amp; Stories</h4>
                            <p class="fs-12 text-muted mb-3">
                                Here you can see the latest posts, Stories, and activities shared by the Mithila community.
                                <a class="text-primary" style="display:none" href="">Learn more</a>
                            </p>
                        </div>
                        <div class="table-responsive mb-0 projects-stat fs-14">
                            <table class="table table-hover table-bordered mb-0 text-md-nowrap text-lg-nowrap text-xl-nowrap">
                                <thead>
                                    <tr>
                                        <th>Post / Stories</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="project-names">

                                                <p class="d-inline-block font-weight-semibold mb-0 fs-14">Total Posts</p>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="badge bg-success" id="txtTotalPosts"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="project-names">

                                                <p class="d-inline-block font-weight-semibold mb-0 fs-14">Today's Stories</p>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="badge bg-warning" id="txtTotalStories"></div>
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>


    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
    (function () {
        function renderChart(labels, usersData, businessesData, postsData) {
            // ensure canvas
            var container = document.getElementById('communitygrowth1');
            container.innerHTML = '<canvas id="communityGrowthChart" style="width:100%; height:320px;"></canvas>';
            var ctx = document.getElementById('communityGrowthChart').getContext('2d');

            // destroy previous chart if exists
            if (window.communityChart) {
                window.communityChart.destroy();
            }

            window.communityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Users',
                            data: usersData,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                            borderWidth: 2,
                            borderColor: 'rgba(92,107,192,0.9)',
                            backgroundColor: 'rgba(92,107,192,0.12)'
                        },
                        {
                            label: 'Businesses',
                            data: businessesData,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                            borderWidth: 2,
                            borderColor: 'rgba(224,37,92,0.9)',
                            backgroundColor: 'rgba(224,37,92,0.12)'
                        },
                        {
                            label: 'Posts',
                            data: postsData,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3,
                            borderWidth: 2,
                            borderColor: 'rgba(40,167,69,0.9)',
                            backgroundColor: 'rgba(40,167,69,0.12)'
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function bindCountsAndChart() {
            $.ajax({
                url: '/Home/GetDashboardSummary',
                method: 'GET',
                dataType: 'json',
                success: function (res) {
                    if (!res || !res.success) {
                        console.error('Failed to load dashboard summary', res);
                        return;
                    }

                    var totals = res.totals || {};
                    var months = res.months || [];

                    // Bind totals - update these IDs in your page
                    $('#txtTotalUsers').text(totals.TotalUsers || 0);
                    $('#txtTotalBusiness').text(totals.TotalBusinesses || 0);
                    $('#txtTotalCategory').text(totals.TotalCategories || 0);
                    $('#txtTotalSubCategory').text(totals.TotalSubCategories || 0);

                    $('#txtTotalStories').text(totals.TotalStories || 0);
                    $('#txtTotalPosts').text(totals.TotalPosts || 0);
                    // add other binds if present
                    // $('#txtTotalStories').text(totals.TotalStories || 0);
                    // $('#txtTotalPosts').text(totals.TotalPosts || 0);

                    // Prepare chart arrays (chronological order)
                    var labels = [];
                    var usersData = [];
                    var businessesData = [];
                    var postsData = [];

                    // months array depends on order from SP; reorder if necessary.
                    // We'll assume SP provided chronological oldest -> newest.
                    months.forEach(function (m) {
                        labels.push(m.MonthLabel); // yyyy-MM
                        usersData.push(m.UsersCount);
                        businessesData.push(m.BusinessesCount);
                        postsData.push(m.PostsCount);
                    });

                    renderChart(labels, usersData, businessesData, postsData);
                },
                error: function (err) {
                    console.error('Error fetching dashboard data', err);
                }
            });
        }

        // initial load
        $(function () {
            bindCountsAndChart();

            // Optional: refresh every N minutes
            // setInterval(bindCountsAndChart, 1000 * 60 * 5); // every 5 minutes
        });
    })();
</script>


<script>
    document.querySelectorAll('.post').forEach(post => {
        const likeBtn = post.querySelector('.like-btn');
        const emojiBox = post.querySelector('.emoji-reactions');
        const commentBtn = post.querySelector('.comment-btn');
        const commentsDiv = post.querySelector('.comments');
        const commentBox = post.querySelector('.comment-box');
        const commentInput = post.querySelector('.comment-input');

        // Emoji selection
        emojiBox.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', () => {
                likeBtn.innerHTML = emoji.dataset.emoji + " Like";
            });
        });

        // Show comment box
        commentBtn.addEventListener('click', () => {
            commentBox.classList.toggle('d-none');
            commentInput.focus();
        });

        // Submit comment on Enter
        commentInput.addEventListener('keypress', e => {
            if (e.key === "Enter" && commentInput.value.trim() !== "") {
                const commentEl = document.createElement('div');
                commentEl.classList.add('comment');
                commentEl.textContent = commentInput.value.trim();
                commentsDiv.appendChild(commentEl);
                commentInput.value = "";
            }
        });
    });
</script>